language: php

php:
  - '7.1'
env:
  global:
    - ZIP_FILENAME=hosted-jft-plugin-build${TRAVIS_BUILD_NUMBER}-${TRAVIS_COMMIT}.zip
    - S3_BUCKET=archives.bmlt.app
    - S3_KEY=hosted-jft
jobs:
  include:

    - stage: lint
      install:
        - composer install
      script:
        - find . -name "*.php" ! -path '*/vendor/*' -print0 | xargs -0 -n1 -P8 php -l
        - vendor/squizlabs/php_codesniffer/bin/phpcs --warning-severity=6 --standard=PSR2 --ignore=vendor --extensions=php --report=summary ./
    - stage: zip file
      env:
        - BUILD_DIR=build
        - DIST_DIR_S3=dist/s3
        - DIST_DIR_GITHUB=dist/github
        - GITHUB_RELEASE_FILENAME=hosted-jft-plugin.zip
        - PLUGIN="hosted-jft"
        - MAINFILE="hosted-jft-plugin.php"
      script:
        - find ./ -type d | xargs chmod 755
        - find ./ -name '*.php' | xargs chmod 644
        - zip -r $ZIP_FILENAME ./ -x "*.git*" -x "*.editorconfig*" -x "*.travis.yml*" -x "*vendor*" -x "Dockerfile" -x "*assets*" -x "composer.*" -x "*docs*" && mkdir $BUILD_DIR && mv $ZIP_FILENAME $BUILD_DIR/
      before_deploy:
        - mkdir -p $DIST_DIR_S3 && cp $BUILD_DIR/$ZIP_FILENAME $DIST_DIR_S3/$ZIP_FILENAME
        - mkdir -p $DIST_DIR_GITHUB && cp $BUILD_DIR/$ZIP_FILENAME $DIST_DIR_GITHUB/$GITHUB_RELEASE_FILENAME
        - curl -LO https://raw.githubusercontent.com/bmlt-enabled/bmlt-wordpress-deploy/master/deploy-wordpress.sh
        - chmod +x deploy-wordpress.sh
        - curl -LO https://raw.githubusercontent.com/bmlt-enabled/release-notes-tool/master/release-notes.sh
        - chmod +x release-notes.sh
        - ./release-notes.sh readme.txt "wp"
      deploy:
        - provider: s3
          access_key_id: AKIA3EWZC3OHKYCL5SIY
          secret_access_key:
            secure: noBjoK4P/qXeg3UFTHzk5sHhu1l6j97BQkyHhVM3mzydlWJJel1M74f+iua0tRd0XMXFCbg7IvryrfN8FIHkqDSmKFotnpDdyqoqewyhQoEYGNXK/zS5Cy6WuVsjl+hMIsGuQVCh1EDFuxXnyt2R2mHG9PPT25UBYcD0AHeL542gb8cA8WcLGcCcID5hVNRnbBc1jtFav8LZaHYkV+4PiI7P8/ObaWObeXQFrj+6HiX1zmRi45heTvjZ43kbfUoz7P/7TGGWGXZQgqr8JTEEcm1PtkysvDOF7VqvNiLOZ25NxQuzBn0XhqgutJqsRFjZEuYCe4eD4wyx28VDDOM6FQfLNl2R/p/RXjx2XcKt9fmgmv4TvU/Vc4blr0Rnb464aC3MXyls5ZuV529+FN4+fcpm4TT3rsBGQgIRN9zUhSUHXaE5175UCK2OHAHnaEz7AltJj0EDj2/8aY5EK3S0RdIKKNFpCUAZW3cSZh/2ARzDB9CCaQqBKIMK01DvEDyKbUDlWFbxfIA0bs75xqWM77kRqEKGa5SKWze7kyGO+dGGxLNZJ28o/MXP4g9zgV0MhhufEnKFudenepDk6xj9RtfuatfPWVfuYuUDaOwyUh/SfbkkQPqR8rlqSXZZ8ip3Jtky8ccMgkid7DpRL5OOZ00Xr9puozQSdK0PoGakWSs=
          bucket: "$S3_BUCKET"
          local_dir: "$DIST_DIR_S3"
          upload-dir: "$S3_KEY"
          skip_cleanup: true
          on:
            all_branches: true
        - provider: releases
          edge: true
          release_notes_file: "changelog.txt"
          token:
            secure: QMbWm9UZqxEvcdmGKSSkYpEubE8sPAbYOqHqALMFX2iP2yKJS53Hcu8syW7huu3PZyTragiQxmf9SpbL4x5zei6nMQ+9oPDjGXzQDt2DxyoiA1lSi3wBKzy7tPxQ1Mcmdm9pmgX81dEzl4dr5MSH7u6Ma8cFiKYM8dOBAVXNxQawgesiTElU9dU9SdGJ9bZbvW4tSC/6xDr31Yj03YnWJa07ErP8UNC6yDL8pVPVmffpHqqunDZe49cqPnh5E0SJsgytoSYLU/03fOWmi7TOLnJuwXJf4Tm5jrijrjpIx1nUuit5Xp2ceag50T1xcFdv9GYU5vI0ayGR5OjppkjgoySxLHhzpCuMk5zzRso1WZDXE/KoKfhlY0UPY/mLBnsyRop3KWrJYwpQd7vBY5VT2N7YVvjx8D7MPtEk40UUAaUCeN/USSuEG8RoT7vgoLuDHMXGhR90mCOv5icyy4ZmMXfyl9xD51rBFnbD7P/VlgzkV64VzU5/Kflu+kyN9ZNW0jS7ecaGJLzfCAprMX6+yy8y3+PjRkfdrxxa1WnixxIHntS/Triueo9021pUUxfneKu+KsxeHUr6KUOrlzE0N8S3xM2oqDkJ79ED/4dJaSfiQTe52/eA6WYD0SOmfpQknKmBbH10m6A6Uc0nA06/SCScZM2bO/VJXjNlPPWsB14=
          file: "$DIST_DIR_GITHUB/$GITHUB_RELEASE_FILENAME"
          name: "$TRAVIS_TAG"
          on:
            tags: true
            condition: $TRAVIS_TAG != *beta*
        - provider: releases
          api_key:
            secure: QMbWm9UZqxEvcdmGKSSkYpEubE8sPAbYOqHqALMFX2iP2yKJS53Hcu8syW7huu3PZyTragiQxmf9SpbL4x5zei6nMQ+9oPDjGXzQDt2DxyoiA1lSi3wBKzy7tPxQ1Mcmdm9pmgX81dEzl4dr5MSH7u6Ma8cFiKYM8dOBAVXNxQawgesiTElU9dU9SdGJ9bZbvW4tSC/6xDr31Yj03YnWJa07ErP8UNC6yDL8pVPVmffpHqqunDZe49cqPnh5E0SJsgytoSYLU/03fOWmi7TOLnJuwXJf4Tm5jrijrjpIx1nUuit5Xp2ceag50T1xcFdv9GYU5vI0ayGR5OjppkjgoySxLHhzpCuMk5zzRso1WZDXE/KoKfhlY0UPY/mLBnsyRop3KWrJYwpQd7vBY5VT2N7YVvjx8D7MPtEk40UUAaUCeN/USSuEG8RoT7vgoLuDHMXGhR90mCOv5icyy4ZmMXfyl9xD51rBFnbD7P/VlgzkV64VzU5/Kflu+kyN9ZNW0jS7ecaGJLzfCAprMX6+yy8y3+PjRkfdrxxa1WnixxIHntS/Triueo9021pUUxfneKu+KsxeHUr6KUOrlzE0N8S3xM2oqDkJ79ED/4dJaSfiQTe52/eA6WYD0SOmfpQknKmBbH10m6A6Uc0nA06/SCScZM2bO/VJXjNlPPWsB14=
          file: "$DIST_DIR_GITHUB/$GITHUB_RELEASE_FILENAME"
          skip_cleanup: true
          name: "$TRAVIS_TAG"
          prerelease: true
          on:
            tags: true
            condition: $TRAVIS_TAG =~ "beta"
        - provider: script
          script: ./deploy-wordpress.sh
          skip_cleanup: true
          on:
            tags: true
