language: php

php:
  - '7.1'
env:
  global:
    - ZIP_FILENAME=hosted-jft-plugin-build${TRAVIS_BUILD_NUMBER}-${TRAVIS_COMMIT}.zip
    - S3_BUCKET=archives.bmlt.app
    - S3_KEY=hosted-jft
jobs:
  include:

    - stage: lint
      install:
        - composer install
      script:
        - find . -name "*.php" ! -path '*/vendor/*' -print0 | xargs -0 -n1 -P8 php -l
        - vendor/squizlabs/php_codesniffer/bin/phpcs --warning-severity=6 --standard=PSR2 --ignore=vendor --extensions=php --report=summary ./
    - stage: zip file
      env:
        - BUILD_DIR=build
        - DIST_DIR_S3=dist/s3
        - DIST_DIR_GITHUB=dist/github
        - GITHUB_RELEASE_FILENAME=hosted-jft-plugin.zip
        - PLUGIN="hosted-jft"
        - MAINFILE="hosted-jft-plugin.php"
      script:
        - find ./ -type d | xargs chmod 755
        - find ./ -name '*.php' | xargs chmod 644
        - zip -r $ZIP_FILENAME ./ -x "*.git*" -x "*.editorconfig*" -x "*.travis.yml*" -x "*vendor*" -x "Dockerfile" -x "*assets*" -x "composer.*" -x "*docs*" && mkdir $BUILD_DIR && mv $ZIP_FILENAME $BUILD_DIR/
      before_deploy:
        - mkdir -p $DIST_DIR_S3 && cp $BUILD_DIR/$ZIP_FILENAME $DIST_DIR_S3/$ZIP_FILENAME
        - mkdir -p $DIST_DIR_GITHUB && cp $BUILD_DIR/$ZIP_FILENAME $DIST_DIR_GITHUB/$GITHUB_RELEASE_FILENAME
        - curl -LO https://raw.githubusercontent.com/bmlt-enabled/bmlt-wordpress-deploy/master/deploy-wordpress.sh
        - chmod +x deploy-wordpress.sh
        - curl -LO https://raw.githubusercontent.com/bmlt-enabled/release-notes-tool/master/release-notes.sh
        - chmod +x release-notes.sh
        - ./release-notes.sh readme.txt "wp"
      deploy:
        - provider: s3
          access_key_id: AKIA3EWZC3OHKYCL5SIY
          secret_access_key:
            secure: noBjoK4P/qXeg3UFTHzk5sHhu1l6j97BQkyHhVM3mzydlWJJel1M74f+iua0tRd0XMXFCbg7IvryrfN8FIHkqDSmKFotnpDdyqoqewyhQoEYGNXK/zS5Cy6WuVsjl+hMIsGuQVCh1EDFuxXnyt2R2mHG9PPT25UBYcD0AHeL542gb8cA8WcLGcCcID5hVNRnbBc1jtFav8LZaHYkV+4PiI7P8/ObaWObeXQFrj+6HiX1zmRi45heTvjZ43kbfUoz7P/7TGGWGXZQgqr8JTEEcm1PtkysvDOF7VqvNiLOZ25NxQuzBn0XhqgutJqsRFjZEuYCe4eD4wyx28VDDOM6FQfLNl2R/p/RXjx2XcKt9fmgmv4TvU/Vc4blr0Rnb464aC3MXyls5ZuV529+FN4+fcpm4TT3rsBGQgIRN9zUhSUHXaE5175UCK2OHAHnaEz7AltJj0EDj2/8aY5EK3S0RdIKKNFpCUAZW3cSZh/2ARzDB9CCaQqBKIMK01DvEDyKbUDlWFbxfIA0bs75xqWM77kRqEKGa5SKWze7kyGO+dGGxLNZJ28o/MXP4g9zgV0MhhufEnKFudenepDk6xj9RtfuatfPWVfuYuUDaOwyUh/SfbkkQPqR8rlqSXZZ8ip3Jtky8ccMgkid7DpRL5OOZ00Xr9puozQSdK0PoGakWSs=
          bucket: "$S3_BUCKET"
          local_dir: "$DIST_DIR_S3"
          upload-dir: "$S3_KEY"
          skip_cleanup: true
          on:
            all_branches: true
        - provider: releases
          edge: true
          release_notes_file: "changelog.txt"
          token:
            secure: U4f+yh7ZCJeNz5kRW5YgOqLGqkPc6TupKYlV76Poc0LIV1o7PhfW5Uam+BBhbRORnYxV2s3vXwdWF6hzyjNtQljzUKZofx1LOYl6PzkD1RvzndXPEFb2xj5ASpcgDIYjbMFr3ZYkIalOuPKmdbpOHdavF9s3MMJqQZA2OPF+5JDLDpU+CpSepPtB1xEuc5IBXf98jBt3CuPTLkcSccuuf5O7lBTdXHAieEQnIiX8qxlsfsbj1lgj3FJbvAwAevfkHMHb/IidTMkCgTwFhvjbGtNLhrpkfRo7NKvTE5qe8JpJHCiwJgRMHbhy2Cv0dORjUD5WPfuTQkbe24CB/z64xwzQgZv7edbO977mxMXG9CIcF7ZvzTy26d3LXAHq8uECIgYoFS/IfpyJG0KOWhRt5Zpo7Mr7+kPwuVL1PzDQ4ciMKhlh5CxReSFCPs5ER4L4FkWD1WvVvzWknUpH759ONlaHV97COhZIaWOtvXKsLSETi/F6+JoKiAhKTNrklWPg67S7YvuIWbGCOt+/N0DnKBmf3RuEu+Nj9bvVgmv6xE0kpN4FK1d/7LX53Vn/xHM87HQfl6hWhwXWNf+QP+0LSEImaJLx1jtJqjOTnlh06Z2Nb3pszmaSKe59wHn8ig/kn/b/DW1K/f2XxeFZxkfCW/gEtL2J02KVNE8y3Ncr7M0=
          file: "$DIST_DIR_GITHUB/$GITHUB_RELEASE_FILENAME"
          name: "$TRAVIS_TAG"
          on:
            tags: true
            condition: $TRAVIS_TAG != *beta*
        - provider: releases
          api_key:
            secure: U4f+yh7ZCJeNz5kRW5YgOqLGqkPc6TupKYlV76Poc0LIV1o7PhfW5Uam+BBhbRORnYxV2s3vXwdWF6hzyjNtQljzUKZofx1LOYl6PzkD1RvzndXPEFb2xj5ASpcgDIYjbMFr3ZYkIalOuPKmdbpOHdavF9s3MMJqQZA2OPF+5JDLDpU+CpSepPtB1xEuc5IBXf98jBt3CuPTLkcSccuuf5O7lBTdXHAieEQnIiX8qxlsfsbj1lgj3FJbvAwAevfkHMHb/IidTMkCgTwFhvjbGtNLhrpkfRo7NKvTE5qe8JpJHCiwJgRMHbhy2Cv0dORjUD5WPfuTQkbe24CB/z64xwzQgZv7edbO977mxMXG9CIcF7ZvzTy26d3LXAHq8uECIgYoFS/IfpyJG0KOWhRt5Zpo7Mr7+kPwuVL1PzDQ4ciMKhlh5CxReSFCPs5ER4L4FkWD1WvVvzWknUpH759ONlaHV97COhZIaWOtvXKsLSETi/F6+JoKiAhKTNrklWPg67S7YvuIWbGCOt+/N0DnKBmf3RuEu+Nj9bvVgmv6xE0kpN4FK1d/7LX53Vn/xHM87HQfl6hWhwXWNf+QP+0LSEImaJLx1jtJqjOTnlh06Z2Nb3pszmaSKe59wHn8ig/kn/b/DW1K/f2XxeFZxkfCW/gEtL2J02KVNE8y3Ncr7M0=
          file: "$DIST_DIR_GITHUB/$GITHUB_RELEASE_FILENAME"
          skip_cleanup: true
          name: "$TRAVIS_TAG"
          prerelease: true
          on:
            tags: true
            condition: $TRAVIS_TAG =~ "beta"
        - provider: script
          script: ./deploy-wordpress.sh
          skip_cleanup: true
          on:
            tags: true
